function logToSheet(message) {
  // Get the active spreadsheet and the Logs sheet
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  var logsSheet = spreadsheet.getSheetByName("Logs");

  // If the Logs sheet does not exist, create it
  if (!logsSheet) {
    logsSheet = spreadsheet.insertSheet("Logs");
  }

  // Determine the next available row in the Logs sheet
  var nextRow = logsSheet.getLastRow() + 1;

  // Set the log message in the appropriate cell
  logsSheet.getRange(nextRow, 1).setValue(message);
}

function onEdit(e) {
    // Get the edited range and value
    var editedRange = e.range;
    var editedValue = e.value;
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var outputSheet = spreadsheet.getSheetByName("Output");
    var logsSheet = spreadsheet.getSheetByName("Logs");

    // Check if the edited cell is in the "Output" sheet and is the dropdown cell (C1)
    if (editedRange.getSheet().getName() === "Output" && editedRange.getA1Notation() === "C1" && editedValue === "Run") {
        logToSheet("Dropdown changed to 'Run'. Starting data organization.");
        // Call the function to organize data when the dropdown is set to "Run"
        organizeData();
    }
    
    // Check if the edited cell is in the "Output" sheet and is the checkbox cell (D1)
    if (editedRange.getSheet().getName() === "Output" && editedRange.getA1Notation() === "D1") {
        // If the checkbox is checked (value is true)
        if (editedValue) {
            // Clear everything in Output sheet after row 2
            outputSheet.getRange("A3:Z" + outputSheet.getMaxRows()).clearContent();

            // Clear everything in Logs sheet
            logsSheet.clear();
        }
    }
}


function organizeData() {
    // Get references to the sheets
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var roosterTeethSheet = spreadsheet.getSheetByName("RoosterTeeth");
    var youtubeSheet = spreadsheet.getSheetByName("Youtube");
    var outputSheet = spreadsheet.getSheetByName("Output");
    logToSheet("Got references to sheets.");

    // Determine the starting row for the output sheet
    var lastOutputRow = outputSheet.getLastRow();
    var outputStartRow = lastOutputRow + 1;
    logToSheet("Determined last row in output sheet.");

    // Batch sizes
    var youtubeBatchSize = 5; // Process 5 YouTube rows at a time
    var roosterTeethBatchSize = 20; // Process 20 RoosterTeeth rows at a time
    logToSheet(`Set YouTube batch size to ${youtubeBatchSize} and RoosterTeeth batch size to ${roosterTeethBatchSize}.`);

    // Get YouTube data and skip header row
    var youtubeDataRange = youtubeSheet.getDataRange();
    var youtubeData = youtubeDataRange.getValues();
    youtubeData.shift();

    // Define column index for show name in RoosterTeeth sheet (column E)
    var showNameColumnIndex = 4; // Zero-based index, so E is 4
    logToSheet("Defined column index for show name.");

    // Define the desired show name for comparison
    var desiredShowName = "VS";
    logToSheet("Set desired show name.");

    // Process YouTube data in batches of 5 rows
    var youtubeRowIndex = 0;
    while (youtubeRowIndex < youtubeData.length) {
        // Get the end index for the current batch of YouTube rows
        var youtubeEndIndex = Math.min(youtubeRowIndex + youtubeBatchSize, youtubeData.length);

        // Array to hold matches for the current batch of YouTube rows
        var outputData = [];
        logToSheet("Processing new batch of YouTube rows.");

        // Process each YouTube row in the current batch
        for (var i = youtubeRowIndex; i < youtubeEndIndex; i++) {
            var youtubeRow = youtubeData[i];
            var youtubeDate = new Date(youtubeRow[3]);
            var youtubeURL = youtubeRow[1];

            // Initialize match found flag
            var matchFound = false;

            // Process each batch of RoosterTeeth data (20 rows at a time)
            var roosterTeethRowIndex = 1; // Start from row 2, since 1st is header
            while (roosterTeethRowIndex < roosterTeethSheet.getLastRow()) {
                // Define the range of RoosterTeeth batch (20 rows at a time)
                var roosterTeethEndIndex = Math.min(roosterTeethRowIndex + roosterTeethBatchSize - 1, roosterTeethSheet.getLastRow());
                var roosterTeethDataRange = roosterTeethSheet.getRange(roosterTeethRowIndex, 1, roosterTeethEndIndex - roosterTeethRowIndex + 1, 6);
                var roosterTeethData = roosterTeethDataRange.getValues();
                var roosterTeethBackgroundColors = roosterTeethDataRange.getBackgrounds();

                // Process each RoosterTeeth row in the current batch
                for (var j = 0; j < roosterTeethData.length; j++) {
                    var roosterTeethRow = roosterTeethData[j];
                    var roosterTeethDate = new Date(roosterTeethRow[3]);
                    var roosterTeethShowName = roosterTeethRow[showNameColumnIndex];
                    var roosterTeethURL = roosterTeethRow[1];
                    var roosterTeethDateBackgroundColor = roosterTeethBackgroundColors[j][3];

                    // Skip RoosterTeeth rows where the date cell has a green background
                    if (roosterTeethDateBackgroundColor === "#00ff00") {
                        continue; // Skip this RoosterTeeth row because the date cell is green
                    }

                    // Compare YouTube and RoosterTeeth data
                    if (roosterTeethShowName === desiredShowName && youtubeDate.getTime() === roosterTeethDate.getTime()) {
                        // Set background color of RoosterTeeth date cell to green
                        roosterTeethSheet.getRange(roosterTeethRowIndex + j, 4).setBackground("green");
                        logToSheet(`Match found: YouTube URL = ${youtubeURL}, RoosterTeeth URL = ${roosterTeethURL}`);

                        // Add YouTube URL and matching RoosterTeeth URL to output data
                        outputData.push([youtubeURL, roosterTeethURL]);
                        
                        // Update the background color in the array
                        roosterTeethDataRange.getCell(j + 1, 4).setBackground("green");

                        // Break the loop as a match has been found
                        matchFound = true;
                        break;
                    }
                }

                // If match found, stop searching further for the current YouTube row
                if (matchFound) {
                    break;
                }

                // logging to track everytime it moves to a new batch of RT rows while looking for a match on the same YT row
                logToSheet(`No match found in RoosterTeeth batch starting at row ${roosterTeethRowIndex} for YouTube row at index ${i}.`);

                // Move to the next batch of RoosterTeeth rows
                roosterTeethRowIndex = roosterTeethEndIndex + 1;

                // Drop the data from the current batch (removing reference for garbage collection)
                roosterTeethData = [];
            }

            // Handle no match case
            if (!matchFound) {
                outputData.push(["No match found", "no match found"]);
            }
        }

        // Batch update the output sheet with matches from the current YouTube batch
        outputSheet.getRange(outputStartRow, 1, outputData.length, 2).setValues(outputData);
        outputStartRow += outputData.length; // Update the starting row for the next batch of matches

        // Update YouTube row index for the next batch of 5 rows
        youtubeRowIndex = youtubeEndIndex;
        logToSheet("YouTube row index updated.");

        // Reset outputData array for the next YouTube batch
        outputData = [];
    }

    logToSheet("Done.");
    // Reset the dropdown to Stop
    outputSheet.getRange("C1").setValue("Stop");
}
